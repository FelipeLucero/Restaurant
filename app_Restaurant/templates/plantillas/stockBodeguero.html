
{% extends 'plantillas/Restaurant.html' %}

<!DOCTYPE html>
<html lang="en">
<head>
    {% block head %}
    <link rel="shortcut icon" href="#">
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<title>DataTables estilo Bootstrap 5 - NodeJS y Express</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/css/bootstrap.min.css" integrity="sha384-DhY6onE6f3zzKbjUPRc2hOzGAdEf4/Dz+WJwBvEYL/lkkIsI3ihufq9hk9K4lVoK" crossorigin="anonymous">
    <link rel="stylesheet" href="static/css/diseño2.css"> 
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.bundle.min.js" integrity="sha384-BOsAfwzjNJHrJ8cZidOg56tcQWfp6y72vEJ8xQ9w6Quywb24iOsW913URv1IS4GD" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.min.css"> 
	<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap5.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Handlee" rel="stylesheet">

    <style>
        table.dataTable thead {
           background-color:#262325;
           color:aliceblue;
        }     
        
        a{
            text-decoration: none;
            color: #fff;
        }
        
        .botonesFuncionalidades {background-color:#262325 ; color:#D35400; border-color: #D35400; }
        
        .btn:hover{
            color: green ;
            background: black;
        }
        
    </style>

    {% endblock %}
</head>



<body>
    {% block contenido %}
    <div class="mx-auto  main-section" id="myTab" role="tablist"></div>
        <ul class="nav nav-tabs nav-pills justify-content-lg-center">
            <li class="nav-item"  style="background-color: #262325;">
                <a  style="color: #D35400; font-size: 20px;  text-decoration: none; " class="nav-link active" id="stock-tab" data-toggle="tab" href="#stock" role="tab" aria-controls="stock" aria-selected="false">STOCK</a>
            </li>
        
            <li class="nav-item"  style="background-color: #262325">
                <a   style="color:#D35400; font-size: 20px; text-decoration: none;  " class="nav-link" id="movi-tab" data-toggle="tab" href="#movi" role="tab" aria-controls="movi" aria-selected="true">MOVIMIENTOS</a>	
                
                
   			   	
            </li>
        </ul>

        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="stock" role="tabpanel" aria-labelledby="list-tab">
                <div class="container-fluid">
                    <button id="btnCrear" class="btn btn-dark mt-2">Crear Producto</button>
                    <button id="btnVolver" class="btn btn-dark mt-2"  onclick="location.href='http://127.0.0.1:8000/MenuBodeguero'">Volver Menu</button>
                    <div class="row shadow-lg p-3 mb-5">
                        <div class="col">
                            <table id="tablaProductos" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>NUMERO DE PRODUCTO</th>
                                    <th>DESCRIPCIÓN</th>
                                    <th>STOCK</th>
                                    <th>PRECIO UNIDAD</th> 
                                    <th>NOMBRE DE PROVEEDOR</th>                                                      
                                    <th class="text-center">MOVIMIENTOS STOCK</th>                      
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            </table> 
                        </div>
                    </div>
                </div>
            </div>
        

            <div class="tab-pane fade" id="movi" role="tabpanel" aria-labelledby="list-tab">
                <div class="container-fluid">
                    <button id="btnVolver" class="btn btn-dark mt-2"  onclick="location.href='http://127.0.0.1:8000/MenuBodeguero'">Volver Menu</button>
                    <div class="row shadow-lg p-3 mb-5">
                        <div class="col">
                            <table id="tablaMovimientos" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                                <tr>
                                    <th>ID MOVIMIENTO</th>
                                    <th>FECHA</th>
                                    <th>CANTIDAD</th>
                                    <th>TIPO DE MOVIMIENTO</th> 
                                    <th>CODIGO PRODUCTOS</th>                                                                          
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            </table> 
                        </div>
                    </div>
                </div>
            </div>

        </div>


    </div>



    <!--Modal para Crear-->
    <div id="modalCRUD" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>                
                </div>
                <form id="formProductos">    
                    <div class="modal-body">                
                         
                        <label for="" class="col-form-label">Codigo del Producto</label>
                        <input type="number" class="form-control" id="codigoPro"> 

                        <label for="" class="col-form-label">Descripcion del Producto</label>
                        <input type="text" class="form-control" id="descripcion">
                    
                        <label for="" class="col-form-label">Stock Disponible</label>
                        <input id="stock" type="text"  class="form-control">

                        <label for="" class="col-form-label">Precio de la Unidad</label>
                        <input id="precioUnidad" type="number"  class="form-control">

                                                      
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="location.href='http://127.0.0.1:8000/stockBodeguero'" >Cancelar</button>
                        <button type="submit" id="btnGuardar" class="btn btn-dark">Guardar</button>
                    </div>
                </form>    
            </div>
        </div>
    </div>  
   
    <!--Modal para agregar y eliminar stock-->
    <div id="modalU" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel"></h5>                
                </div>
                <form id="formMovimientos">    
                    <div class="modal-body">                

                        <label for="" class="col-form-label">Ingrese la cantidad</label>
                        <input id="stock2" type="text"  class="form-control">
                                                    
                    </div>
                    <div class="modal-footer">
                        <button type="button" id="btnCancelar" class="btn btn-secondary" data-dismiss="modal" onclick="location.href='http://127.0.0.1:8000/stockBodeguero'">Cancelar </button>
                        <button type="submit" id="btnGuardar2" class="btn btn-dark">Guardar</button>
                    </div>
                </form>    
            </div>
        </div>
    </div>  
    
    <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha2/js/bootstrap.min.js" integrity="sha384-5h4UG+6GOuV9qXh6HqOLwZMY4mnLPraeTrjT5v07o347pj6IkfuoASuGBhfDsp3d" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10.0.2/dist/sweetalert2.all.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap5.min.js"></script>  

    <script>
        $(document).ready(function() {   
            let url = 'https://cors-anywhere.herokuapp.com/52.3.46.105/api/Producto';
            let urlAgregar = 'https://cors-anywhere.herokuapp.com/52.3.46.105/api/Producto/agregarStock/';
            let urlRetirar = 'https://cors-anywhere.herokuapp.com/52.3.46.105/api/Producto/retirarDelStock/';
            let urlMovi = 'https://cors-anywhere.herokuapp.com/52.3.46.105/api/Movimiento';
            let opcion = null;
            let codigoPro, descripcion, stock, precioUnidad, fila;
            //MOSTRAR
            let tablaArticulos = $('#tablaProductos').DataTable({            
                "ajax":{
                    "url": url,
                    "dataSrc":""
                },
                "columns":[
                    {"data":"codigoPro"},
                    {"data":"descripcion"},
                    {"data":"stock"},
                    {"data":"precioUnidad"},
                    {"data":"nombreProveedor"},
                    {"defaultContent": "<div class='text-center'><div class='btn-group'><button  class=' btn btn-default botonesFuncionalidades btn-sm btnAgregar'>Agregar </button><button class=' btn btn-default botonesFuncionalidades btn-sm btnRetirar'>Retirar </button></div></div>"}
                ],

                //Para cambiar idioma a español del datatable
                "language":{
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "zeroRecords": "No se encontraron resultados",
                    "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sSearch": "Buscar Producto:",
                    "oPaginate":{
                    "sFirst": "Primero",
                    "sLast":"Último",
                    "sNext":"Siguiente",
                    "sPrevious": "Anterior"
                    },
                    "sProcessing":"Procesando...",
                },

            });
            
            let tablaMovimientos = $('#tablaMovimientos').DataTable({            
                "ajax":{
                    "url": urlMovi,
                    "dataSrc":""
                },
                "columns":[
                    {"data":"idMovimiento"},
                    {"data":"fecha"},
                    {"data":"cantidad"},
                    {"data":"tipoMovimiento"},
                    {"data":"codigoPro"},
                ],

                //Para cambiar idioma a español del datatable
                "language":{
                    "lengthMenu": "Mostrar _MENU_ registros",
                    "zeroRecords": "No se encontraron resultados",
                    "info": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                    "infoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
                    "infoFiltered": "(filtrado de un total de _MAX_ registros)",
                    "sSearch": "Buscar Movimiento:",
                    "oPaginate":{
                    "sFirst": "Primero",
                    "sLast":"Último",
                    "sNext":"Siguiente",
                    "sPrevious": "Anterior"
                    },
                    "sProcessing":"Procesando...",
                },

            });



            //CREAR
            $("#btnCrear").click(function(){
                opcion='crear';            
                //codigoPro=null;
                $("#formProductos").trigger("reset");
                $(".modal-header").css( "background-color", "#262325");
                $(".modal-header").css( "color", "white" );
                $(".modal-title").text("Crear Producto");
                $('#modalCRUD').modal('show');	    
            });

            //AGREGAR      
            $(document).on("click", ".btnAgregar", function(){		            
                opcion='agregar';
                fila = $(this).closest("tr");	        
                codigoPro = parseInt(fila.find('td:eq(0)').text());
                $("#formMovimientos").trigger("reset");
                $("#codigoPro").val(codigoPro);              
                $(".modal-header").css("background-color", "#262325");
                $(".modal-header").css("color", "white" );
                $(".modal-title").text("Agregar Producto");		
                $('#modalU').modal('show');		   
            });

            //RETIRAR      
            $(document).on("click", ".btnRetirar", function(){		            
                opcion='retirar';
                fila = $(this).closest("tr");	        
                codigoPro = parseInt(fila.find('td:eq(0)').text());
                $("#formMovimientos").trigger("reset");
                $("#codigoPro").val(codigoPro);              
                $(".modal-header").css("background-color", "#262325");
                $(".modal-header").css("color", "white" );
                $(".modal-title").text("Retirar Producto");		
                $('#modalU').modal('show');		   
            });
        
            //BORRAR
            /*$(document).on("click", ".btnBorrar", function(){
                fila = $(this);           
                id = parseInt($(this).closest('tr').find('td:eq(0)').text());            
                Swal.fire({
                    title: '¿Confirma eliminar el registro?',                
                    showCancelButton: true,
                    confirmButtonText: `Confirmar`,                
                    }).then((result) => {               
                    if (result.isConfirmed) {
                        $.ajax({
                            url: url+id,
                            method: 'delete',                        
                            data:  {id:id},    
                            success: function() {
                                tablaArticulos.row(fila.parents('tr')).remove().draw();                  
                            }
                        });
                        Swal.fire('¡Registro Eliminado!', '', 'success')
                    } 
                    })
            }); 
            */

            //submit para el CREAR y EDITAR
            $('#formProductos').submit(function(e){    
                //header.Add('Access-Control-Allow-Origin *');                      
                e.preventDefault();  
                codigoPro = $.trim($('#codigoPro').val());  
                descripcion = $.trim($('#descripcion').val());
                stock = $.trim($('#stock').val());    
                precioUnidad = $.trim($('#precioUnidad').val());             
                if(opcion=='crear'){                
                    $.ajax({                    
                        url: url,
                        method: 'post',                                                         
                        contentType: 'application/json',  
                        data:  JSON.stringify({codigoPro:codigoPro, descripcion:descripcion, stock:stock, precioUnidad:precioUnidad}),                       
                        success: function(data) {                       
                            tablaArticulos.ajax.reload(null, false); 
                            location.href='http://127.0.0.1:8000/stockBodeguero'

                        }
                    });	
                }
                                
                $('#modalCRUD').modal('hide');										     			
            });

            $('#formMovimientos').submit(function(e){    
                //header.Add('Access-Control-Allow-Origin *');                      
                e.preventDefault();  
                stock = $.trim($('#stock2').val());    
                        
                if(opcion=='agregar'){
                    console.log("EDITAR");
                    $.ajax({                    
                        url: urlAgregar+codigoPro,
                        method: 'put',                                        
                        contentType: 'application/json',  
                        data:  JSON.stringify({ stock:stock}),                       
                        success: function(data) {                       
                            tablaArticulos.ajax.reload(null, false);
                            tablaMovimientos.ajax.reload(null, false); 
                            location.href='http://127.0.0.1:8000/stockBodeguero'
                        }
                    });	
                }  

                if(opcion=='retirar'){
                    console.log("EDITAR");
                    $.ajax({                    
                        url: urlRetirar+codigoPro,
                        method: 'put',                                        
                        contentType: 'application/json',  
                        data:  JSON.stringify({ stock:stock}),                       
                        success: function(data) {                       
                            tablaArticulos.ajax.reload(null, false);
                            tablaMovimientos.ajax.reload(null, false); 
                            location.href='http://127.0.0.1:8000/stockBodeguero'
                        }
                    });	
                }         		        
                $('#modalU').modal('hide');	

            }); 




        });
        
    </script>

{% endblock %}

</body>
</html>